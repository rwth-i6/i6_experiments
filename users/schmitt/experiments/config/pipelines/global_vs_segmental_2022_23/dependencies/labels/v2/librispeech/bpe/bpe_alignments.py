from i6_experiments.users.schmitt.experiments.config.pipelines.global_vs_segmental_2022_23.dependencies.general.rasr.formats import \
  RasrFormats
from i6_experiments.users.schmitt.experiments.config.pipelines.global_vs_segmental_2022_23.dependencies.labels.v2.general import \
  SegmentalLabelDefinition
from i6_experiments.users.schmitt.experiments.config.pipelines.global_vs_segmental_2022_23.dependencies.labels.v2.librispeech.bpe.bpe import \
  LibrispeechBPE10025
from i6_experiments.users.schmitt.experiments.config.pipelines.global_vs_segmental_2022_23.dependencies.labels.v2.librispeech.general import \
  LibrispeechLabelDefinition
from i6_experiments.users.schmitt.experiments.config.pipelines.global_vs_segmental_2022_23.dependencies.general.hyperparameters import \
  SegmentalModelHyperparameters
from i6_experiments.users.schmitt.rasr.convert import BPEJSONVocabToRasrFormatsJob, JsonSubwordVocabToLexiconJob

from typing import Dict
import copy

from sisyphus import *


class LibrispeechBpe10025CtcAlignment(LibrispeechBPE10025, LibrispeechLabelDefinition, SegmentalLabelDefinition):
  """
    This alignment is generated by the RNA full-sum model from Albert's "Improved Transducer".
    See: https://github.com/rwth-i6/returnn-experiments/tree/master/2020-rnn-transducer.
  """

  @property
  def alias(self) -> str:
    return "bpe"

  @property
  def model_hyperparameters(self) -> SegmentalModelHyperparameters:
    return SegmentalModelHyperparameters(
      sos_idx=0, target_num_labels=10026, sil_idx=None, blank_idx=10025)

  @property
  def rasr_format_paths(self) -> RasrFormats:
    json_to_rasr_job = BPEJSONVocabToRasrFormatsJob(
      Path(
        "/u/zeineldeen/setups/librispeech/2022-11-28--conformer-att/work/i6_core/text/label/subword_nmt/train/ReturnnTrainBpeJob.vTq56NZ8STWt/output/bpe.vocab"),
      blank_idx=10025)

    vocab_to_lexicon_job = JsonSubwordVocabToLexiconJob(
      json_vocab_path=Path(
        "/u/zeineldeen/setups/librispeech/2022-11-28--conformer-att/work/i6_core/text/label/subword_nmt/train/ReturnnTrainBpeJob.vTq56NZ8STWt/output/bpe.vocab"),
      blank_idx=10025,
    )

    return RasrFormats(
      state_tying_path=json_to_rasr_job.out_state_tying,
      allophone_path=json_to_rasr_job.out_allophones,
      label_file_path=json_to_rasr_job.out_rasr_label_file,
      decoding_lexicon_path=vocab_to_lexicon_job.out_lexicon,
      realignment_lexicon_path=vocab_to_lexicon_job.out_lexicon,
      blank_allophone_state_idx=40096
    )

  @property
  def alignment_paths(self):
    return {}
